use std::env;
use std::fs;
use std::path::PathBuf;
use std::process::{Command, exit};

fn main() {
    let path = match env::args().nth(1) {
        Some(p) => PathBuf::from(p),
        None => {
            eprintln!("Usage: copyfile-link path/to/file.md");
            exit(1);
        }
    };

    // Resolve absolute path
    let abs = match fs::canonicalize(&path) {
        Ok(ap) => ap,
        Err(_) => {
            eprintln!("Error: Could not resolve '{}'", path.display());
            exit(1);
        }
    };

    if !abs.is_file() {
        eprintln!("Error: '{}' is not a file", abs.display());
        exit(1);
    }

    let script = format!(r#"
        tell application "System Events"
            set the clipboard to (POSIX file "{}") as alias
        end tell
    "#, abs.display());

    let status = Command::new("osascript")
        .arg("-e")
        .arg(script)
        .status()
        .expect("Failed to execute osascript");

    if status.success() {
        println!("✅ File link copied: {}", abs.display());
    } else {
        eprintln!("❌ osascript returned non-zero exit code");
        exit(1);
    }
}
